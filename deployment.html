<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="genindex.html" /><link rel="search" title="Search" href="search.html" /><link rel="next" title="Contributing" href="contributing.html" /><link rel="prev" title="Processing" href="processing.html" />

    <!-- Generated with Sphinx 7.1.2 and Furo 2023.07.26 -->
        <title>Deployment - Arcana v0.10.7</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=d8449d71" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?v=36a5483c" />
    
    


<style>
  body {
    --color-code-background: #ffffff;
  --color-code-foreground: black;
  --color-brand-primary: #7b112d;
  --color-brand-content: #7b112d;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #111111;
  --color-code-foreground: #ffffff;
  --color-brand-primary: #b94e5e;
  --color-brand-content: #b94e5e;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #111111;
  --color-code-foreground: #ffffff;
  --color-brand-primary: #b94e5e;
  --color-brand-content: #b94e5e;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">Arcana v0.10.7</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="_static/logo_small.png" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">Arcana v0.10.7</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_model.html">Data model</a></li>
<li class="toctree-l1"><a class="reference internal" href="processing.html">Processing</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Deployment</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="design_analyses.html">Designing Analyses</a></li>
<li class="toctree-l1"><a class="reference internal" href="adding_formats.html">New formats and spaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="alternative_stores.html">Alternative storage</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="cli.html">CLI</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="deployment">
<h1>Deployment<a class="headerlink" href="#deployment" title="Permalink to this heading">#</a></h1>
<p>Arcana provides tools for deploying pipelines in Docker containers
that can be run in XNAT’s <a class="reference external" href="https://wiki.xnat.org/container-service/">container service</a>. Pipelines
can be built done on an individual basis or as part of a wider a suite (e.g.
<a class="reference external" href="https://github.com/australian-imaging-service/pipelines-core">Australian Imaging Service Pipelines</a>).
As well as building Docker images, the deployment workflow includes
procedures to test and generate documentation.</p>
<section id="command-definitions">
<h2>Command definitions<a class="headerlink" href="#command-definitions" title="Permalink to this heading">#</a></h2>
<p>The XNAT container service uses <a class="reference external" href="https://wiki.xnat.org/container-service/command-resolution-122978876.html">command configuration files</a>
saved in the <cite>org.nrg.commands</cite> image label to resolve metadata for the pipelines
that available on a given Docker image. The <code class="xref py py-meth docutils literal notranslate"><span class="pre">XnatViaCS.generate_xnat_command()</span></code>
method is used to generate the JSON metadata to be saved in this field.</p>
<p>There are four key fields that will determine the functionality of the command
(the rest are metadata fields that are exposed to the XNAT UI):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">task</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">inputs</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">outputs</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">parameters</span></code></p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">task</span></code> keyword argument should be the path to an installed
Python module containing a Pydra task followed by a colon and the name of
the task, e.g. <code class="docutils literal notranslate"><span class="pre">pydra.tasks.fsl.preprocess.fast:Fast</span></code>. Note that Arcana
will attempt to resolve the package that contains the Pydra task and install the
same version (including local development versions) within the <a class="reference external" href="https://www.anaconda.com/">Anaconda</a> environment
in the image. <code class="docutils literal notranslate"><span class="pre">inputs</span></code> and <code class="docutils literal notranslate"><span class="pre">parameters</span></code> expose text boxes in the XNAT dialog when
the pipelines are run. <code class="docutils literal notranslate"><span class="pre">outputs</span></code> determine where the outputs will
be stored in the XNAT data tree.</p>
<p>Inputs prompt the user to enter selection criteria for
input data and are used by the entrypoint of the Docker containers to add
source columns to the dataset (see <a class="reference internal" href="data_model.html#data-columns"><span class="std std-ref">Frames: Rows and Columns</span></a>). They are specified by
4-tuple consisting of</p>
<ul class="simple">
<li><p>name of field in the pydra task input interface</p></li>
<li><p>datatype required by pydra task</p></li>
<li><p>description of input that will be exposed to the XNAT UI</p></li>
<li><p>the row row_frequency of the column (see <a class="reference internal" href="data_model.html#data-spaces"><span class="std std-ref">Spaces</span></a> and <a class="reference internal" href="data_model.html#data-columns"><span class="std std-ref">Frames: Rows and Columns</span></a>)</p></li>
</ul>
<p>Parameters are passed directly through the pipeline add method (see <a class="reference internal" href="processing.html#applying-workflows"><span class="std std-ref">Pydra workflows</span></a>) that
is run in the container, and consist of a 2-tuple with</p>
<ul class="simple">
<li><p>name of field in the pydra task input interface</p></li>
<li><p>description of parameters that will be exposed to the XNAT UI</p></li>
</ul>
<p>Outputs do not show up in the XNAT dialog and are specified by a 3-tuple:</p>
<ul class="simple">
<li><p>name of field in the pydra task output interface</p></li>
<li><p>datatype produced by pydra task</p></li>
<li><p>destination path (slashes are permitted interpreted as a relative path from the derivatives root)</p></li>
</ul>
<p>When working with the CLI, command configurations are stored in <a class="reference external" href="https://yaml.org">YAML</a> format,
with keys matching the arguments of <code class="xref py py-meth docutils literal notranslate"><span class="pre">XnatViaCS.generate_xnat_command()</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">image_tag</span></code> and <code class="docutils literal notranslate"><span class="pre">registry</span></code> are omitted from the YAML representation
of the commands as they are provided by the image configuration
(see <a class="reference internal" href="#building"><span class="std std-ref">Building</span></a>)</p>
</div>
</section>
<section id="building">
<h2>Building<a class="headerlink" href="#building" title="Permalink to this heading">#</a></h2>
<p>Dockerfiles for pipeline images are created using <a class="reference external" href="https://github.com/ReproNim/neurodocker">Neurodocker</a>
and can therefore work with any Debian/Ubuntu or Red-Hat based images
(ensuring that the value for <code class="docutils literal notranslate"><span class="pre">base_image&gt;package_manager</span></code> is set to the correct value,
i.e.  <code class="docutils literal notranslate"><span class="pre">&quot;apt&quot;</span></code> for Debian based or <code class="docutils literal notranslate"><span class="pre">&quot;yum&quot;</span></code> for Red-Hat based). Arcana installs
itself into the Docker image within an <a class="reference external" href="https://www.anaconda.com/">Anaconda</a> environment named “arcana”. Therefore,
it shouldn’t conflict with packages on existing Docker images for third-party
pipelines.</p>
<p>Extending the <a class="reference external" href="https://yaml.org">YAML</a> format used to define the command configurations,
the full configuration required to build an XNAT docker image looks like</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">FMRIB Scientific Library (FSL)</span>
<span class="nt">version</span><span class="p">:</span>
<span class="w">    </span><span class="nt">package</span><span class="p">:</span><span class="w"> </span><span class="nl">&amp;package_version</span><span class="w"> </span><span class="s">&#39;6.0.1&#39;</span>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;1&#39;</span>
<span class="nt">authors</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Thomas G. Close</span>
<span class="w">      </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">thomas.close@sydney.edu.au</span>
<span class="nt">base_image</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">brainlife/fsl&#39;</span>
<span class="w">    </span><span class="nt">tag</span><span class="p">:</span><span class="w"> </span><span class="nv">*package_version</span>
<span class="w">    </span><span class="nt">package_manager</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apt</span>
<span class="nt">packages</span><span class="p">:</span>
<span class="w">    </span><span class="nt">neurodocker</span><span class="p">:</span>
<span class="w">        </span><span class="nt">dcm2niix</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1.0.20201102</span>
<span class="w">    </span><span class="nt">pip</span><span class="p">:</span>
<span class="w">        </span><span class="nt">pydra-dcm2niix</span><span class="p">:</span><span class="w">  </span><span class="c1"># Uses the default version on PyPI</span>
<span class="nt">docs</span><span class="p">:</span>
<span class="w">    </span><span class="nt">info_url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://fsl.fmrib.ox.ac.uk/fsl/fslwiki</span>
<span class="nt">command</span><span class="p">:</span>
<span class="w">    </span><span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pydra.tasks.fsl.preprocess.fast:FAST</span>
<span class="w">    </span><span class="nt">description</span><span class="p">:</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">FAST (FMRIBs Automated Segmentation Tool) segments a 3D image of</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">the brain into different tissue types (Grey Matter, White Matter,</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">CSF, etc.), whilst also correcting for spatial intensity variations</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">(also known as bias field or RF inhomogeneities).</span>
<span class="w">    </span><span class="nt">inputs</span><span class="p">:</span>
<span class="w">        </span><span class="nt">in_files</span><span class="p">:</span>
<span class="w">          </span><span class="nt">datatype</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">medimage/nifti-gz</span>
<span class="w">          </span><span class="nt">column_defaults</span><span class="p">:</span>
<span class="w">            </span><span class="nt">datatype</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">medimage/dicom-set</span>
<span class="w">          </span><span class="nt">help</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Anatomical image to segment into different tissues</span>
<span class="w">    </span><span class="nt">outputs</span><span class="p">:</span>
<span class="w">        </span><span class="nt">tissue_classes</span><span class="p">:</span>
<span class="w">          </span><span class="nt">datatype</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">medimage/nifti-gz</span>
<span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fast/tissue-classes</span>
<span class="w">          </span><span class="nt">help</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Segmented tissue classes</span>
<span class="w">        </span><span class="nt">probability_maps</span><span class="p">:</span>
<span class="w">          </span><span class="nt">datatype</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">medimage/nifti-gz</span>
<span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fast/probability-map</span>
<span class="w">          </span><span class="nt">help</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Probability maps for tissue classes</span>
<span class="w">    </span><span class="nt">parameters</span><span class="p">:</span>
<span class="w">        </span><span class="nt">use_priors</span><span class="p">:</span>
<span class="w">          </span><span class="nt">help</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Use priors in tissue estimation</span>
<span class="w">        </span><span class="nt">bias_lowpass</span><span class="p">:</span>
<span class="w">          </span><span class="nt">help</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Low-pass filter bias field</span>
<span class="w">    </span><span class="nt">configuration</span><span class="p">:</span>
<span class="w">        </span><span class="nt">output_biasfield</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">        </span><span class="nt">bias_lowpass</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5.0</span>
<span class="w">    </span><span class="nt">row_frequency</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">session</span>
<span class="nt">arcana_spec_version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.0</span>
</pre></div>
</div>
<p>The CLI command to build the image from the <a class="reference external" href="https://yaml.org">YAML</a> configuration is</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>arcana<span class="w"> </span>deploy<span class="w"> </span>make-app<span class="w"> </span>xnat:XnatApp<span class="w"> </span><span class="s1">&#39;your-pipeline-config.yml&#39;</span>
<span class="go">Successfully built &quot;FSL&quot; image with [&quot;fast&quot;] commands</span>
</pre></div>
</div>
<p>To build a suite of pipelines from a series of <a class="reference external" href="https://yaml.org">YAML</a> files stored in a directory tree
simply provide the root directory instead and Arcana will walk the sub-directories
and attempt to build any <a class="reference external" href="https://yaml.org">YAML</a> files it finds, e.g.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>arcana<span class="w"> </span>deploy<span class="w"> </span>make-app<span class="w"> </span>xnat:XnatApp<span class="w"> </span><span class="s1">&#39;config-root-dir&#39;</span>
<span class="go">./config-root-dir/mri/neuro/fsl.yml: FSL [fast]</span>
<span class="go">./config-root-dir/mri/neuro/mrtrix3.yml: MRtrix3 [dwi2fod, dwi2tensor, tckgen]</span>
<span class="go">./config-root-dir/mri/neuro/freesurfer.yml: Freesurfer [recon-all]</span>
<span class="go">...</span>
</pre></div>
</div>
</section>
<section id="testing">
<h2>Testing<a class="headerlink" href="#testing" title="Permalink to this heading">#</a></h2>
<p>After an image has been built successfully, it can be tested against previously
generated results to check for consistency with previous versions. This can be
particularly useful when updating dependency versions. Tests that don’t match
previous results within a given tolerance will be flagged for manual review.</p>
<p>To avoid expensive runs when not necessarily (particularly within CI/CD
pipelines), in the case that the provenance data saved along the generated
reference data will be checked before running the pipelines. If the provenance
data would be unchanged (including software dependency versions), then the
pipeline test will be skipped.</p>
<p>Test data, both inputs to the pipeline and reference data to check against
pipeline outputs, need to be stored in separate directories for each command.
Under the pipeline data directory, there should be one or more subdirectories
for different tests of the pipeline, and in each of these subdirectories there
should be an <code class="docutils literal notranslate"><span class="pre">inputs</span></code> and an <code class="docutils literal notranslate"><span class="pre">outputs</span></code> directory, and optionally a <a class="reference external" href="https://yaml.org">YAML</a>
file named <code class="docutils literal notranslate"><span class="pre">parameters.yml</span></code>. Inside the <code class="docutils literal notranslate"><span class="pre">inputs</span></code> directory there should be
file-groups named after each input of the pipeline, and likewise in the
<code class="docutils literal notranslate"><span class="pre">outputs</span></code> directory there should be file-groups named after each output
of the pipeline. Any field inputs or outputs should be placed alongside the
file-groups in a JSON file called <code class="docutils literal notranslate"><span class="pre">__fields__.json</span></code>.</p>
<p>Specifying two tests (‘test1’ and ‘test2’) for the FSL FAST example given above
(see <a class="reference internal" href="#building"><span class="std std-ref">Building</span></a>) the directory structure would look like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FAST
├── test1
│   ├── inputs
│   │   └── in_files.nii.gz
│   ├── outputs
|   │   └── fast
|   │       ├── tissue_class_files.nii.gz
|   │       ├── partial_volumes.nii.gz
|   │       ├── partial-volume-files.nii.gz
|   │       ├── bias-field.nii.gz
|   │       └── probability-map.nii.gz
│   └── parameters.yml
└── test2
    ├── inputs
    │   └── in_files.nii.gz
    ├── outputs
    │   └── fast
    │       ├── tissue_class_files.nii.gz
    │       ├── partial_volumes.nii.gz
    │       ├── partial-volume-files.nii.gz
    │       ├── bias-field.nii.gz
    │       └── probability-map.nii.gz
    └── parameters.yml
</pre></div>
</div>
<p>To run a test via the CLI point the test command to the <a class="reference external" href="https://yaml.org">YAML</a> configuration
file and the data directory containing the test data, e.g.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>arcana<span class="w"> </span>deploy<span class="w"> </span><span class="nb">test</span><span class="w"> </span>./fast.yml<span class="w"> </span>./fast-data
<span class="go">Pipeline test &#39;test1&#39; ran successfully and outputs matched saved</span>
<span class="go">Pipeline test &#39;test2&#39; ran successfully and outputs matched saved</span>
</pre></div>
</div>
<p>To run tests over a suite of image configurations in a directory containing a
number of <a class="reference external" href="https://yaml.org">YAML</a> configuration files (i.e. same as building) simply provide the
directory to <code class="docutils literal notranslate"><span class="pre">arcana</span> <span class="pre">deploy</span> <span class="pre">test</span></code> instead of the path to the <a class="reference external" href="https://yaml.org">YAML</a> config
file and supply a directory tree containing the test data, with matching
sub-directory structure to the configuration dir. For example, given the following
directory structure for the configuration files</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>mri
└── neuro
    ├── fsl.yml
    ├── mrtrix3.yml
    ...
</pre></div>
</div>
<p>The test data should be laid out like</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>mri-data
└── neuro
    ├── fsl
    │   └── fast
    |       ├── test1
    |       │   ├── inputs
    |       │   │   └── in_files.nii.gz
    |       │   ├── outputs
    |       |   │   └── fast
    |       |   │       ├── tissue_class_files.nii.gz
    |       |   │       ├── partial_volumes.nii.gz
    |       |   │       ├── partial-volume-files.nii.gz
    |       |   │       ├── bias-field.nii.gz
    |       |   │       └── probability-map.nii.gz
    |       │   └── parameters.yml
    |       └── test2
    |           ├── inputs
    |           │   └── in_files.nii.gz
    |           ├── outputs
    |           │   └── fast
    |           │       ├── tissue_class_files.nii.gz
    |           │       ├── partial_volumes.nii.gz
    |           │       ├── partial-volume-files.nii.gz
    |           │       ├── bias-field.nii.gz
    |           │       └── probability-map.nii.gz
    |           └── parameters.yml
    └── mrtrix3
        ├── dwi2fod
        |   ├── test1
        |   |   ├── inputs
    ...
</pre></div>
</div>
<p>Like in the case of a single <a class="reference external" href="https://yaml.org">YAML</a> configuration file, the CLI command to test
a suite of image/command configurations is.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>arcana<span class="w"> </span>deploy<span class="w"> </span><span class="nb">test</span><span class="w"> </span>./mri<span class="w"> </span>./mri-data<span class="w"> </span>--output<span class="w"> </span>test-results.json
<span class="go">...E..F..</span>
</pre></div>
</div>
<p>While not strictly necessary, it is strongly advised to store test data alongside
image/command configurations inside some kind of version control. However, storing
large files inside vanilla Git repositories is <strong>not recommended</strong>, therefore, you
will probably want to use one of the extensions designed for dealing with large
files:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://git-lfs.github.com/">git-lfs</a> - integrates with GitHub but GitHub requires you to pay for storage/egest</p></li>
<li><p><a class="reference external" href="https://git-annex.branchable.com/">git-annex</a> - complicated to set up and use, even for experienced Git users, but much more flexible in your storage options.</p></li>
</ul>
</section>
<section id="autodocs">
<h2>Autodocs<a class="headerlink" href="#autodocs" title="Permalink to this heading">#</a></h2>
<p>Documentation can be automatically generated using from the
pipeline configuration <a class="reference external" href="https://yaml.org">YAML</a> files (see <a class="reference internal" href="#building"><span class="std std-ref">Building</span></a>) using</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>arcana<span class="w"> </span>deploy<span class="w"> </span>docs<span class="w"> </span>&lt;path-to-yaml-or-directory&gt;<span class="w"> </span>&lt;docs-output-dir&gt;
</pre></div>
</div>
<p>Generated HTML documents will be placed in the output dir, with pipelines
organised hierarchically to match the structure of the source directory.</p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="contributing.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Contributing</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="processing.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Processing</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2023, Thomas G. Close
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Deployment</a><ul>
<li><a class="reference internal" href="#command-definitions">Command definitions</a></li>
<li><a class="reference internal" href="#building">Building</a></li>
<li><a class="reference internal" href="#testing">Testing</a></li>
<li><a class="reference internal" href="#autodocs">Autodocs</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="./" id="documentation_options" src="_static/documentation_options.js?v=31ca06fa"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="_static/scripts/furo.js?v=32e29ea5"></script>
    </body>
</html>